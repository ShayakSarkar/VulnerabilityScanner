<!DOCTYPE html>

<html>
	<?php
		session_start();
	?>
	<head>
		<title>Local Scan</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="local.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body style="background:#031321;">
		
		<div  style="text-decoration-line:underline;color: orange;padding: 0px 70px;display: inline-block;font-size: 40px;float:left;">Local Scan</div>
		<div  class="heading" style="text-decoration-line:underline;text-decoration-style:dashed;">
		<i class="fa fa-code"></i> Vulnerability Scanner
		</div>

		<br><br><br><br>
		<ul>
			 <li><a href="index.php" title="Back to Home"><i class="fa fa-home" ></i></a></li>
			 <li><a href="#Theme"><i class="fa fa-adjust"></i> Theme</a></li>
			 <li><a href="#save"><i class="fa fa-save"></i> Save</a></li>
			 <li><a href="#help"><i class="fa fa-question-circle"></i> Help</a></li>
		</ul>
		<iframe src="local1.html" align=right style="align:right;border:10px solid lightgray;border-top:0px;height:100000px;width:753px;"></iframe>

		<!----------------------------------------- Here Layeth Thy Code ----------------------------------------------->
		
		<?php
			system("touch newFile");
			$_SESSION["INPUT_FILE"]=fopen("products.txt","r");	// $INPUT_FILE --> stream to products.txt
			
			$_SESSION["FILE_CONTENTS"]=fread($_SESSION["INPUT_FILE"],filesize("products.txt"));			
			$_SESSION["FILE_CONTENTS"]=explode(",",$_SESSION["FILE_CONTENTS"]);		// $FILE_CONTENTS --> Array of system apps
			function render($product){
				$index=0;
				
				echo "<div style=\"color: blue; position: absolute; left: 50%; top: 29%; font-family: ubuntu; font-size: 20px;\"><b>${product["name"]}</b></div>";
				echo "<div id=\"Information\">"	;
				while($index<count($product["cve_list"])){
					$cve=$product["cve_list"][$index];
					
					echo "<pre>
					
					
				    
	                            <b>${index}</b>)   <b>GENERAL INFORMATION :- </b>  
					-----------------------------------------------
						CVE-ID: ${cve["cve_id"]}
						CWE-ID: ${cve["cwe_id"]}
						Number of Exploits: ${cve["no_of_exploits"]}
						Vulnerability Types: ${cve["vulnerability_types"]}
						Publish Date: ${cve["publish_date"]}
						Update Date: ${cve["update_date"]}
						Vulnerability Score: ${cve["score"]}
						Access Level: ${cve["access_level"]}	
						Access type: ${cve["access"]}
						Complexity of Vulnerability: ${cve["complexity"]}
						Authentication: ${cve["authentication"]}
						
					<b>BREACH OF CIA</b>
					---------------------	
						Confidentiality: ${cve["confidentiality"]}
						Integrity: ${cve["integrity"]}
						availability: ${cve["availability"]}
					
					<b>Final Notes:</b> 
					---------------------</pre>";
					
					$splittedString=explode(" ",$cve["notes"]);
					$stringPos=0;
					$lineSize=10;
					while($stringPos<count($splittedString)){
						$numberOfWords=0;
						while($numberOfWords<$lineSize && $stringPos+$numberOfWords<count($splittedString)){
							if($numberOfWords==0){
								echo "<pre>	                            ";
							}
							echo "${splittedString[$stringPos+$numberOfWords]} ";
							$numberOfWords=$numberOfWords+1;
						}
						echo "</pre>";
						
						$stringPos=$stringPos+$lineSize;
						
					}			
					$index=$index+1;
					
				}
				
				echo "</div>";
			}
			function searchByName($name){
				$filePath="./JsonDatabase/".strtoupper($name[0]).".json";
				$rawData=file_get_contents("./JsonDatabase/".strtoupper($name[0]).".json");
				$nameUpper=strtoupper($name);
				$rootObj=json_decode($rawData,true);
				$products=$rootObj["products"];
				$index=0;
				while($index<count($products)){
					if(strpos(strtoupper($products[$index]["name"]),$nameUpper)!=false){
						return $products[$index];
					}
					$index=$index+1;
				}

				return null;
			}
			 
			function scanPrevious(){
				if($_SESSION["FILE_CONTENTS_INDEX"]==0)
					$_SESSION["FILE_CONTENTS_INDEX"]=$_SESSION["FILE_CONTENTS_INDEX"]+1;
				$_SESSION["FILE_CONTENTS_INDEX"]=$_SESSION["FILE_CONTENTS_INDEX"]-1;
				$productName=$_SESSION["FILE_CONTENTS"][$_SESSION["FILE_CONTENTS_INDEX"]];
				$productName=trim($productName);
				$product=searchByName($productName);
				render($product);
				$_SESSION["CURRENT_PRODUCT"]=$product;
				$_SESSION["CURRENT_PRODUCT_NAME"]=$product["name"];
			}
				
			function scanNext(){
				if($_SESSION["FILE_CONTENTS_INDEX"]==count($_SESSION["FILE_CONTENTS"])-2)
					$_SESSION["FILE_CONTENTS_INDEX"]=$_SESSION["FILE_CONTENTS_INDEX"]-1;
				$_SESSION["FILE_CONTENTS_INDEX"]=$_SESSION["FILE_CONTENTS_INDEX"]+1;
				$productName=$_SESSION["FILE_CONTENTS"][$_SESSION["FILE_CONTENTS_INDEX"]];
				$productName=trim($productName);
				$product=searchByName($productName);
				render($product);
				$_SESSION["CURRENT_PRODUCT"]=$product;
				$_SESSION["CURRENT_PRODUCT_NAME"]=$product["name"];
			}
			function generateReport(){
				if(!array_key_exists("CURRENT_PRODUCT",$_SESSION)){
					return null;
				}
				$reportFileName=implode("",explode(" ",$_SESSION["CURRENT_PRODUCT_NAME"].".json"));
				$currentProductJson=json_encode($_SESSION["CURRENT_PRODUCT"]);
				$reportStream=fopen($reportFileName,"w");
				fwrite($reportStream,$currentProductJson);
				fclose($reportStream);
			}
			if(array_key_exists('scanNext',$_POST)){
				scanNext();
			}
			else if(array_key_exists('scanPrevious',$_POST)){
				scanPrevious();
			}
			else if(array_key_exists('generateReport',$_POST)){
				generateReport();
			}
		?>


		<img id="FileIcon" src="FileIcon.png"/>
		<img id="SearchIcon" src="Search.png"/>
		<img id="PreviousIcon" src="Previous.png"/>
		<img id="NextIcon" src="Previous.png"/>
		
		<form method="post">
			<button name="scanPrevious" id="ScanPreviousButton" class="GenFileButton">
				Scan Previous
			</button>
			
			<button name="scanNext" id="ScanNextButton" class="GenFileButton">
				Scan Next
			</button> 
			<button name="generateReport" id="GenerateReportButton">
					Generate Json Report<br> 
					For this product
			</button>
			
			<?php 
				$DOWNLOAD_FILE_NAME=implode("",explode(" ",$_SESSION["CURRENT_PRODUCT_NAME"].'.json'));	
			?>
			<a href="<?php echo "$DOWNLOAD_FILE_NAME" ?>" id="ReportDownloadLink" target="_blank">
				report
			</a>
					
		</form>
	</body>
</html>
